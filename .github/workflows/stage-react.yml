name: Stage PR

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to stage'
        required: true
        type: number
      branch:
        description: 'Branch name to checkout'
        required: true
        type: string
      allow_fresh_db:
        description: 'Allow staging without production database (first-time deployment)'
        required: false
        type: boolean
        default: false

jobs:
  stage:
    runs-on: [self-hosted, NUC]
    
    steps:
      - name: Validate environment
        run: |
          echo "CURRENT_STEP=validate_environment" >> $GITHUB_ENV
          
          if [ -z "$RUBIGO_DEPLOY_ROOT" ]; then
            echo "❌ RUBIGO_DEPLOY_ROOT environment variable is not set."
            echo "   Run: production/scripts/install-service.sh"
            exit 1
          fi
          
          if [ ! -d "$RUBIGO_DEPLOY_ROOT" ]; then
            echo "❌ RUBIGO_DEPLOY_ROOT does not exist: $RUBIGO_DEPLOY_ROOT"
            exit 1
          fi
          
          echo "✅ RUBIGO_DEPLOY_ROOT: $RUBIGO_DEPLOY_ROOT"
          
          STAGING_BASE="$RUBIGO_DEPLOY_ROOT/staging/rubigo-react/runs/${{ github.run_id }}"
          echo "STAGING_BASE=$STAGING_BASE" >> $GITHUB_ENV
          echo "LAST_COMPLETED_STEP=validate_environment" >> $GITHUB_ENV

      - name: Checkout PR branch
        run: echo "CURRENT_STEP=checkout" >> $GITHUB_ENV
      - name: Checkout PR branch (action)
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          clean: true
      - name: Mark checkout complete
        run: echo "LAST_COMPLETED_STEP=checkout" >> $GITHUB_ENV

      - name: Prepare staging directory
        run: |
          echo "CURRENT_STEP=prepare_staging_dir" >> $GITHUB_ENV
          
          mkdir -p "$STAGING_BASE/data" "$STAGING_BASE/logs"
          
          rm -rf "$STAGING_BASE/code"
          cp -r rubigo-react "$STAGING_BASE/code"
          
          mkdir -p "$STAGING_BASE/code/.git"
          
          echo "Staging directory prepared: $STAGING_BASE"
          echo "LAST_COMPLETED_STEP=prepare_staging_dir" >> $GITHUB_ENV

      - name: Sanity check
        run: |
          echo "CURRENT_STEP=sanity_check" >> $GITHUB_ENV
          
          cd "$STAGING_BASE/code"
          
          echo "Checking required executables..."
          
          if ! command -v bun &> /dev/null; then
            echo "❌ bun is not installed or not in PATH"
            exit 1
          fi
          echo "  ✓ bun $(bun --version)"
          
          if ! command -v sqlite3 &> /dev/null; then
            echo "❌ sqlite3 is not installed or not in PATH"
            exit 1
          fi
          echo "  ✓ sqlite3 $(sqlite3 --version | cut -d' ' -f1-2)"
          
          if ! command -v ss &> /dev/null; then
            echo "❌ ss is not installed or not in PATH"
            exit 1
          fi
          echo "  ✓ ss (iproute2)"
          
          if ! command -v curl &> /dev/null; then
            echo "❌ curl is not installed or not in PATH"
            exit 1
          fi
          echo "  ✓ curl $(curl --version | head -1 | cut -d' ' -f2)"
          
          if ! command -v jq &> /dev/null; then
            echo "❌ jq is not installed or not in PATH"
            exit 1
          fi
          echo "  ✓ jq $(jq --version)"
          
          echo "Checking critical files..."
          
          if [ ! -f "package.json" ]; then
            echo "❌ Missing package.json"
            exit 1
          fi
          echo "  ✓ package.json"
          
          if [ ! -f "bun.lock" ]; then
            echo "❌ Missing bun.lock"
            exit 1
          fi
          echo "  ✓ bun.lock"
          
          if [ ! -f "next.config.ts" ] && [ ! -f "next.config.js" ]; then
            echo "❌ Missing next.config"
            exit 1
          fi
          echo "  ✓ next.config"
          
          echo "✅ Sanity check passed"
          echo "LAST_COMPLETED_STEP=sanity_check" >> $GITHUB_ENV

      - name: Cleanup
        if: always()
        run: |
          rm -rf "$STAGING_BASE"
          echo "✅ Cleaned up staging directory"
