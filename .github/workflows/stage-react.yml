name: Stage PR

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to stage'
        required: true
        type: number
      branch:
        description: 'Branch name to checkout'
        required: true
        type: string
      allow_fresh_db:
        description: 'Allow staging without production database (first-time deployment)'
        required: false
        type: boolean
        default: false

jobs:
  stage:
    runs-on: [self-hosted, NUC]
    env:
      RUN_ID: ${{ github.run_id }}
      OLLAMA_URL: http://localhost:11434
      OLLAMA_MODEL: gemma3:4b
      SFU_URL: NONE
      PORT: 4530
    
    steps:
      - name: Validate environment
        run: bun run rubigo-react/scripts/production/deploy.ts validate-env

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          clean: true

      - name: Cleanup stale processes
        run: bun run rubigo-react/scripts/production/deploy.ts cleanup-stale

      - name: Validate migrations
        run: bun run rubigo-react/scripts/production/validate-migrations.ts rubigo-react

      - name: Prepare staging directory
        id: prepare
        run: |
          OUTPUT=$(bun run rubigo-react/scripts/production/deploy.ts prepare --target staging --run-id $RUN_ID --source rubigo-react)
          echo "$OUTPUT"
          # Extract paths from output
          echo "BUILD_DIR=$(echo "$OUTPUT" | grep '^BUILD_DIR=' | cut -d= -f2)" >> $GITHUB_ENV
          echo "BASE_DIR=$(echo "$OUTPUT" | grep '^BASE_DIR=' | cut -d= -f2)" >> $GITHUB_ENV
          echo "DATA_DIR=$(echo "$OUTPUT" | grep '^DATA_DIR=' | cut -d= -f2)" >> $GITHUB_ENV

      - name: Sanity check
        run: bun run rubigo-react/scripts/production/deploy.ts sanity-check --dir "$BUILD_DIR"

      - name: Clone production database
        run: |
          PROD_DB="$RUBIGO_DEPLOY_ROOT/production/rubigo-react/data/rubigo.db"
          STAGING_DB="$DATA_DIR/rubigo.db"
          ALLOW_FRESH="${{ inputs.allow_fresh_db }}"
          bun run rubigo-react/scripts/production/deploy.ts clone-db --source "$PROD_DB" --target "$STAGING_DB" --allow-fresh "$ALLOW_FRESH"

      - name: Install dependencies
        run: bun run rubigo-react/scripts/production/deploy.ts install-deps --dir "$BUILD_DIR"

      - name: Backup staging DB before schema changes
        run: bun run rubigo-react/scripts/production/deploy.ts backup-db --db "$DATA_DIR/rubigo.db" --backup-dir "$BASE_DIR/backups" --run-id $RUN_ID

      - name: Apply database schema
        run: bun run rubigo-react/scripts/production/deploy.ts db-schema --dir "$BUILD_DIR" --db-url "$DATA_DIR/rubigo.db"

      - name: Build application
        run: bun run rubigo-react/scripts/production/deploy.ts build --dir "$BUILD_DIR" --db-url "$DATA_DIR/rubigo.db"

      - name: Find available port
        run: |
          OUTPUT=$(bun run rubigo-react/scripts/production/deploy.ts find-port)
          echo "$OUTPUT"
          echo "STAGING_PORT=$(echo "$OUTPUT" | grep '^STAGING_PORT=' | cut -d= -f2)" >> $GITHUB_ENV

      - name: Start staging server
        run: bun run rubigo-react/scripts/production/deploy.ts start-server --dir "$BUILD_DIR" --port $STAGING_PORT --db-url "$DATA_DIR/rubigo.db" --logs-dir "$BASE_DIR/logs"

      - name: Initialize and capture API token
        run: |
          OUTPUT=$(bun run rubigo-react/scripts/production/deploy.ts init-capture-token --port $STAGING_PORT --logs-dir "$BASE_DIR/logs")
          echo "$OUTPUT"
          # Extract environment variables from output
          TOKEN=$(echo "$OUTPUT" | grep '^STAGING_API_TOKEN=' | cut -d= -f2)
          DB_INIT=$(echo "$OUTPUT" | grep '^DB_INITIALIZED=' | cut -d= -f2)
          [ -n "$TOKEN" ] && echo "STAGING_API_TOKEN=$TOKEN" >> $GITHUB_ENV
          [ -n "$DB_INIT" ] && echo "DB_INITIALIZED=$DB_INIT" >> $GITHUB_ENV

      - name: Health check
        run: bun run rubigo-react/scripts/production/deploy.ts health-check --port $STAGING_PORT --token "$STAGING_API_TOKEN" --attempts 10

      - name: Run E2E tests
        id: e2e_tests
        continue-on-error: true
        run: |
          cd "$BUILD_DIR"
          export PLAYWRIGHT_BASE_URL="http://localhost:$STAGING_PORT"
          export RUBIGO_API_URL="http://localhost:$STAGING_PORT"
          export RUBIGO_API_TOKEN="$STAGING_API_TOKEN"
          export DATABASE_URL="$DATA_DIR/rubigo.db"
          
          echo "Running E2E tests against staging:"
          echo "  PLAYWRIGHT_BASE_URL: $PLAYWRIGHT_BASE_URL"
          echo "  RUBIGO_API_URL: $RUBIGO_API_URL"
          
          bun run test:e2e 2>&1 | tee "$BASE_DIR/logs/e2e-output.log"

      - name: Generate staging report
        if: always()
        run: |
          bun run rubigo-react/scripts/production/deploy.ts generate-report \
            --base-dir "$BASE_DIR" \
            --pr-number "${{ inputs.pr_number }}" \
            --branch "${{ inputs.branch }}" \
            --commit "${{ github.sha }}" \
            --run-id "${{ github.run_id }}" \
            --port "${STAGING_PORT:-0}" \
            --db-initialized "${DB_INITIALIZED:-false}" \
            --e2e-outcome "${{ steps.e2e_tests.outcome }}"

      - name: Stop staging server
        if: always()
        run: bun run rubigo-react/scripts/production/deploy.ts stop-server --port "$STAGING_PORT"

      - name: Upload staging report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: staging-report
          path: ${{ env.BASE_DIR }}/staging-report.json

      - name: Upload staging logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: staging-logs
          path: ${{ env.BASE_DIR }}/logs/

      - name: Cleanup staging directory
        if: always()
        run: bun run rubigo-react/scripts/production/deploy.ts cleanup --dir "$BASE_DIR"
