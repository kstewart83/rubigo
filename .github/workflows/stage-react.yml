name: Stage PR

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to stage'
        required: true
        type: number
      branch:
        description: 'Branch name to checkout'
        required: true
        type: string
      allow_fresh_db:
        description: 'Allow staging without production database'
        required: false
        type: boolean
        default: false

jobs:
  stage:
    runs-on: [self-hosted, NUC]
    env:
      RUN_ID: ${{ github.run_id }}
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          clean: true

      - name: Cleanup stale processes
        run: |
          pkill -f "playwright.*test-server" 2>/dev/null || true
          pkill -f "bun.*4530" 2>/dev/null || true
          echo "✅ Cleaned up stale processes"

      - name: Validate environment
        run: bun run rubigo-react/scripts/production/deploy.ts validate-env

      - name: Validate migrations
        run: bun run rubigo-react/scripts/production/validate-migrations.ts rubigo-react

      - name: Prepare staging directory
        run: |
          OUTPUT=$(bun run rubigo-react/scripts/production/deploy.ts prepare --target staging --run-id $RUN_ID --source rubigo-react)
          echo "$OUTPUT"
          echo "BUILD_DIR=$(echo "$OUTPUT" | grep '^BUILD_DIR=' | cut -d= -f2)" >> $GITHUB_ENV
          echo "BASE_DIR=$(echo "$OUTPUT" | grep '^BASE_DIR=' | cut -d= -f2)" >> $GITHUB_ENV
          echo "DATA_DIR=$(echo "$OUTPUT" | grep '^DATA_DIR=' | cut -d= -f2)" >> $GITHUB_ENV

      - name: Sanity check
        run: |
          echo "PATH=$PATH"
          which sqlite3 || echo "which sqlite3 failed"
          bun run rubigo-react/scripts/production/deploy.ts sanity-check --dir "$BUILD_DIR"

      - name: Clone production database
        run: |
          PROD_DB="$RUBIGO_DEPLOY_ROOT/production/rubigo-react/data/rubigo.db"
          STAGING_DB="$DATA_DIR/rubigo.db"
          ALLOW_FRESH="${{ inputs.allow_fresh_db }}"
          bun run rubigo-react/scripts/production/deploy.ts clone-db --source "$PROD_DB" --target "$STAGING_DB" --allow-fresh "$ALLOW_FRESH"

      - name: Install dependencies
        run: bun run rubigo-react/scripts/production/deploy.ts install-deps --dir "$BUILD_DIR"

      - name: Backup staging DB before schema changes
        run: bun run rubigo-react/scripts/production/deploy.ts backup-db --db "$DATA_DIR/rubigo.db" --backup-dir "$BASE_DIR/backups" --run-id $RUN_ID

      - name: Apply database schema
        run: bun run rubigo-react/scripts/production/deploy.ts db-schema --dir "$BUILD_DIR" --db-url "$DATA_DIR/rubigo.db"

      - name: Build application
        run: bun run rubigo-react/scripts/production/deploy.ts build --dir "$BUILD_DIR" --db-url "$DATA_DIR/rubigo.db"

      - name: Find available port
        run: |
          for port in {4530..4630}; do
            if ! ss -tuln | grep -q ":$port "; then
              echo "STAGING_PORT=$port" >> $GITHUB_ENV
              echo "✅ Found available port: $port"
              exit 0
            fi
          done
          echo "❌ No available port found in range 4530-4630"
          exit 1

      - name: Start staging server
        run: bun run rubigo-react/scripts/production/deploy.ts start-server --dir "$BUILD_DIR" --port $STAGING_PORT --db-url "$DATA_DIR/rubigo.db" --logs-dir "$BASE_DIR/logs"

      - name: Initialize and capture API token
        run: |
          BASE_URL="http://localhost:$STAGING_PORT"
          
          echo "Waiting for server to start..."
          for i in {1..15}; do
            if curl -sf "$BASE_URL/api/init" > /dev/null 2>&1; then
              break
            fi
            echo "  Waiting... ($i/15)"
            sleep 2
          done
          
          INIT_STATUS=$(curl -sf "$BASE_URL/api/init" | jq -r '.initialized')
          
          if [ "$INIT_STATUS" = "false" ]; then
            echo "Fresh database detected - initializing via phrase..."
            
            INIT_WORDS=$(grep -oP 'INIT TOKEN: \K.*' "$BASE_DIR/logs/stdout.log" | head -1)
            
            if [ -z "$INIT_WORDS" ]; then
              echo "❌ Could not find INIT TOKEN in server logs"
              cat "$BASE_DIR/logs/stdout.log"
              exit 1
            fi
            
            echo "  Found init phrase: $INIT_WORDS"
            
            JSON_WORDS=$(echo "$INIT_WORDS" | jq -R 'split(" ")')
            INIT_RESPONSE=$(curl -sf -X POST "$BASE_URL/api/init" \
              -H "Content-Type: application/json" \
              -d "{\"words\": $JSON_WORDS}")
            
            if [ "$(echo "$INIT_RESPONSE" | jq -r '.success')" != "true" ]; then
              echo "❌ Initialization failed: $INIT_RESPONSE"
              exit 1
            fi
            
            echo "✅ System initialized successfully"
            echo "DB_INITIALIZED=true" >> $GITHUB_ENV
          else
            echo "✅ Database already initialized (copied from production)"
            echo "DB_INITIALIZED=true" >> $GITHUB_ENV
          fi
          
          sleep 2
          
          API_TOKEN=$(grep -oP 'API Token: \K[a-f0-9]+' "$BASE_DIR/logs/stdout.log" | head -1)
          
          if [ -n "$API_TOKEN" ]; then
            echo "STAGING_API_TOKEN=$API_TOKEN" >> $GITHUB_ENV
            echo "✅ API token captured (${#API_TOKEN} chars)"
          else
            echo "⚠️ Could not capture API token from logs"
          fi

      - name: Health check
        run: bun run rubigo-react/scripts/production/deploy.ts health-check --port $STAGING_PORT --token "$STAGING_API_TOKEN" --attempts 10

      - name: Run E2E tests
        id: e2e_tests
        continue-on-error: true
        timeout-minutes: 10
        run: |
          cd "$BUILD_DIR"
          export E2E_BASE_URL="http://localhost:$STAGING_PORT"
          export RUBIGO_API_URL="http://localhost:$STAGING_PORT"
          export RUBIGO_API_TOKEN="$STAGING_API_TOKEN"
          export DATABASE_URL="$DATA_DIR/rubigo.db"
          
          echo "Running E2E tests against staging:"
          echo "  PLAYWRIGHT_BASE_URL: $PLAYWRIGHT_BASE_URL"
          echo "  RUBIGO_API_URL: $RUBIGO_API_URL"
          
          bun run test:e2e 2>&1 | tee "$BASE_DIR/logs/e2e-output.log"

      - name: Debug info
        run: |
          echo "✅ Phase 6 complete - server, health, E2E"
          echo "STAGING_PORT: $STAGING_PORT"
          echo "E2E outcome: ${{ steps.e2e_tests.outcome }}"

      - name: Stop staging server
        if: always()
        run: |
          pkill -f "bun.*$STAGING_PORT" 2>/dev/null || true
          echo "Staging server stopped"

      - name: Cleanup
        if: always()
        run: |
          if [ -n "$BASE_DIR" ] && [ -d "$BASE_DIR" ]; then
            rm -rf "$BASE_DIR"
            echo "✅ Cleaned up: $BASE_DIR"
          fi
