name: Stage PR

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to stage'
        required: true
        type: number
      branch:
        description: 'Branch name to checkout'
        required: true
        type: string
      allow_fresh_db:
        description: 'Allow staging without production database (first-time deployment)'
        required: false
        type: boolean
        default: false

jobs:
  stage:
    runs-on: [self-hosted, NUC]
    
    steps:
      - name: Validate environment
        run: |
          echo "CURRENT_STEP=validate_environment" >> $GITHUB_ENV
          
          if [ -z "$RUBIGO_DEPLOY_ROOT" ]; then
            echo "❌ RUBIGO_DEPLOY_ROOT environment variable is not set."
            exit 1
          fi
          
          if [ ! -d "$RUBIGO_DEPLOY_ROOT" ]; then
            echo "❌ RUBIGO_DEPLOY_ROOT does not exist: $RUBIGO_DEPLOY_ROOT"
            exit 1
          fi
          
          echo "✅ RUBIGO_DEPLOY_ROOT: $RUBIGO_DEPLOY_ROOT"
          
          STAGING_BASE="$RUBIGO_DEPLOY_ROOT/staging/rubigo-react/runs/${{ github.run_id }}"
          echo "STAGING_BASE=$STAGING_BASE" >> $GITHUB_ENV
          echo "LAST_COMPLETED_STEP=validate_environment" >> $GITHUB_ENV

      - name: Checkout PR branch
        run: echo "CURRENT_STEP=checkout" >> $GITHUB_ENV
      - name: Checkout PR branch (action)
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          clean: true
      - name: Mark checkout complete
        run: echo "LAST_COMPLETED_STEP=checkout" >> $GITHUB_ENV

      - name: Prepare staging directory
        run: |
          echo "CURRENT_STEP=prepare_staging_dir" >> $GITHUB_ENV
          mkdir -p "$STAGING_BASE/data" "$STAGING_BASE/logs"
          rm -rf "$STAGING_BASE/code"
          cp -r rubigo-react "$STAGING_BASE/code"
          mkdir -p "$STAGING_BASE/code/.git"
          echo "Staging directory prepared: $STAGING_BASE"
          echo "LAST_COMPLETED_STEP=prepare_staging_dir" >> $GITHUB_ENV

      - name: Sanity check
        run: |
          echo "CURRENT_STEP=sanity_check" >> $GITHUB_ENV
          cd "$STAGING_BASE/code"
          echo "Checking required executables..."
          command -v bun && echo "  ✓ bun $(bun --version)"
          command -v sqlite3 && echo "  ✓ sqlite3"
          command -v ss && echo "  ✓ ss"
          command -v curl && echo "  ✓ curl"
          command -v jq && echo "  ✓ jq"
          echo "Checking critical files..."
          [ -f "package.json" ] && echo "  ✓ package.json"
          [ -f "bun.lock" ] && echo "  ✓ bun.lock"
          echo "✅ Sanity check passed"
          echo "LAST_COMPLETED_STEP=sanity_check" >> $GITHUB_ENV

      - name: Validate migrations
        run: |
          echo "CURRENT_STEP=validate_migrations" >> $GITHUB_ENV
          cd "$GITHUB_WORKSPACE"
          bun run production/validate-migrations.ts rubigo-react
          echo "LAST_COMPLETED_STEP=validate_migrations" >> $GITHUB_ENV

      - name: Clone production database
        run: |
          echo "CURRENT_STEP=clone_database" >> $GITHUB_ENV
          
          PROD_BASE="$RUBIGO_DEPLOY_ROOT/production/rubigo-react"
          PROD_DB="$PROD_BASE/data/rubigo.db"
          STAGING_DB="$STAGING_BASE/data/rubigo.db"
          
          if [ -f "$PROD_DB" ]; then
            sqlite3 "$PROD_DB" ".backup '$STAGING_DB'"
            echo "✅ Production database safely cloned to staging"
          else
            if [ "${{ inputs.allow_fresh_db }}" = "true" ]; then
              echo "⚠️ No production database exists (fresh staging allowed by flag)"
            else
              echo "❌ No production database exists at: $PROD_DB"
              exit 1
            fi
          fi
          echo "LAST_COMPLETED_STEP=clone_database" >> $GITHUB_ENV

      - name: Cleanup
        if: always()
        run: |
          rm -rf "$STAGING_BASE"
          echo "✅ Cleaned up staging directory"
