name: Deploy rubigo-react

on:
  workflow_dispatch:  # Allow manual triggers
  push:
    branches: [main]
    paths:
      - 'rubigo-react/**'
      - 'common/**'
      - '.github/workflows/deploy-react.yml'

jobs:
  deploy:
    runs-on: [self-hosted, NUC]
    # Note: RUBIGO_DEPLOY_ROOT must be set in the runner's systemd service
    # env vars BASE and DATABASE_URL are computed in each step using shell variables
    
    steps:
      - name: Validate environment
        run: |
          if [ -z "$RUBIGO_DEPLOY_ROOT" ]; then
            echo "❌ RUBIGO_DEPLOY_ROOT environment variable is not set."
            echo "   Run: production/scripts/install-service.sh"
            exit 1
          fi
          
          if [ ! -d "$RUBIGO_DEPLOY_ROOT" ]; then
            echo "❌ RUBIGO_DEPLOY_ROOT does not exist: $RUBIGO_DEPLOY_ROOT"
            exit 1
          fi
          
          echo "✅ RUBIGO_DEPLOY_ROOT: $RUBIGO_DEPLOY_ROOT"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Preserve gitignored files between deployments
          clean: false

      - name: Prepare build directory
        run: |
          BASE="$RUBIGO_DEPLOY_ROOT/production/rubigo-react"
          BUILD_DIR="$BASE/builds/${{ github.run_id }}"
          mkdir -p "$BUILD_DIR" "$BASE/data" "$BASE/logs" "$BASE/backups"
          
          # Copy app source
          cp -r rubigo-react/* "$BUILD_DIR/"
          
          # Create .git marker for Tailwind v4 content auto-detection
          mkdir -p "$BUILD_DIR/.git"
          
          echo "Build directory prepared: $BUILD_DIR"

      - name: Validate migrations
        run: |
          # Validate migrations from repo root (script is at production/validate-migrations.ts)
          cd "$GITHUB_WORKSPACE"
          bun run production/validate-migrations.ts rubigo-react

      - name: Sanity check
        run: |
          BASE="$RUBIGO_DEPLOY_ROOT/production/rubigo-react"
          BUILD_DIR="$BASE/builds/${{ github.run_id }}"
          cd "$BUILD_DIR"
          
          # Verify critical files exist
          if [ ! -f "package.json" ]; then
            echo "❌ Missing package.json"
            exit 1
          fi
          
          if [ ! -f "bun.lock" ]; then
            echo "❌ Missing bun.lock"
            exit 1
          fi
          
          if [ ! -f "next.config.ts" ] && [ ! -f "next.config.js" ]; then
            echo "❌ Missing next.config"
            exit 1
          fi
          
          echo "✅ Sanity check passed"

      - name: Install dependencies
        run: |
          BASE="$RUBIGO_DEPLOY_ROOT/production/rubigo-react"
          BUILD_DIR="$BASE/builds/${{ github.run_id }}"
          cd "$BUILD_DIR"
          bun install --frozen-lockfile
          echo "✅ Dependencies installed"

      - name: Stop current service
        run: |
          # Stop systemd service (Linux/Ubuntu)
          systemctl --user stop rubigo-react.service 2>/dev/null || true
          pkill -f "bun.*4430" 2>/dev/null || true
          sleep 2
          echo "Service stopped for build"

      - name: Backup database
        run: |
          BASE="$RUBIGO_DEPLOY_ROOT/production/rubigo-react"
          DB_FILE="$BASE/data/rubigo.db"
          if [ -f "$DB_FILE" ]; then
            BACKUP_DIR="$BASE/backups"
            mkdir -p "$BACKUP_DIR"
            BACKUP_FILE="$BACKUP_DIR/rubigo-${{ github.run_id }}-$(date +%Y%m%d_%H%M%S).db"
            cp "$DB_FILE" "$BACKUP_FILE"
            echo "✅ Database backed up to: $BACKUP_FILE"
            # Keep last 10 backups
            ls -t "$BACKUP_DIR"/*.db 2>/dev/null | tail -n +11 | xargs rm -f || true
          else
            echo "⚠️ No existing database to backup (fresh install)"
          fi

      - name: Apply database schema
        run: |
          BASE="$RUBIGO_DEPLOY_ROOT/production/rubigo-react"
          DATABASE_URL="$BASE/data/rubigo.db"
          BUILD_DIR="$BASE/builds/${{ github.run_id }}"
          cd "$BUILD_DIR"
          
          # Use db:push --force - idempotent and safe on existing tables
          DATABASE_URL="$DATABASE_URL" bun run db:push --force
          
          echo "✅ Database schema applied"

      - name: Build application
        run: |
          BASE="$RUBIGO_DEPLOY_ROOT/production/rubigo-react"
          DATABASE_URL="$BASE/data/rubigo.db"
          BUILD_DIR="$BASE/builds/${{ github.run_id }}"
          cd "$BUILD_DIR"
          
          # Create isolated build database copy
          BUILD_DB="$BUILD_DIR/rubigo.db"
          cp "$DATABASE_URL" "$BUILD_DB"
          cp "$DATABASE_URL-wal" "$BUILD_DIR/rubigo.db-wal" 2>/dev/null || true
          cp "$DATABASE_URL-shm" "$BUILD_DIR/rubigo.db-shm" 2>/dev/null || true
          
          # Use isolated build database
          export DATABASE_URL="$BUILD_DB"
          bun run build
          
          echo "Build complete in $BUILD_DIR"

      - name: Deploy (swap symlink and start)
        run: |
          BASE="$RUBIGO_DEPLOY_ROOT/production/rubigo-react"
          BUILD_DIR="$BASE/builds/${{ github.run_id }}"
          
          # Swap symlink to new build
          ln -sfn "$BUILD_DIR" "$BASE/current"
          
          # Start service via systemd
          systemctl --user start rubigo-react.service
          sleep 3
          
          echo "Deployed: $(readlink $BASE/current)"

      - name: Health check
        run: |
          for i in {1..10}; do
            if curl -sf http://localhost:4430 > /dev/null; then
              echo "✅ Health check passed"
              exit 0
            fi
            echo "Waiting for server... ($i/10)"
            sleep 2
          done
          echo "❌ Health check failed"
          exit 1

      - name: Cleanup old builds
        run: |
          BASE="$RUBIGO_DEPLOY_ROOT/production/rubigo-react"
          # Keep last 3 builds
          cd "$BASE/builds"
          ls -dt */ 2>/dev/null | tail -n +4 | xargs rm -rf || true
          echo "Remaining builds: $(ls -d */ 2>/dev/null | wc -l)"
