# ============================================================================
# MMC Integration Data
# ============================================================================
# This file contains requirements for external integrations with Rubigo.
# Following the Requirements & Delivery Ontology.

[description]
overview = """
INTEGRATION REQUIREMENTS
- MCP Server for agent/AI tool integration
- HTTP/SSE transport for production deployment
- Coverage of full Rubigo ontology entities

This data represents Rubigo's extensibility and integration capabilities.
"""

# ============================================================================
# OBJECTIVES - Strategic goals for integration
# ============================================================================

[[objectives]]
id = "obj-rubigo-integration"
title = "Platform Integration and Extensibility"
description = "Rubigo must provide programmatic access to its data and functionality, enabling integration with external tools, automation systems, and AI agents"
project_id = "d4e5f6"
parent_id = "obj-it-business-systems"
status = "active"

# ============================================================================
# FEATURES - Integration capabilities
# ============================================================================

[[features]]
id = "feat-mcp-server"
name = "MCP Server Integration"
description = "Model Context Protocol server that exposes Rubigo data entities as resources and provides tools for CRUD operations, enabling AI agents and LLM-based tools to interact with the platform"
objective_id = "obj-rubigo-integration"
status = "planned"

# ============================================================================
# RULES - User stories for MCP integration
# ============================================================================

# --- Resource Access Rules ---

[[rules]]
id = "rule-mcp-resources-read"
feature_id = "feat-mcp-server"
role = "Rubigo Developer"
requirement = "query Rubigo entities through MCP resources"
reason = "build AI tools that can read and understand Rubigo data"
status = "draft"

[[rules]]
id = "rule-mcp-tools-crud"
feature_id = "feat-mcp-server"
role = "Rubigo Developer"
requirement = "invoke CRUD operations through MCP tools"
reason = "enable AI agents to create, update, and delete Rubigo data programmatically"
status = "draft"

[[rules]]
id = "rule-mcp-transport-sse"
feature_id = "feat-mcp-server"
role = "Rubigo Developer"
requirement = "connect to the MCP server via HTTP/SSE from remote clients"
reason = "integrate AI tools with the production Rubigo instance at rubigo.kwip.net"
status = "draft"

[[rules]]
id = "rule-mcp-auth"
feature_id = "feat-mcp-server"
role = "Rubigo Developer"
requirement = "authenticate MCP connections using API tokens"
reason = "ensure only authorized agents can access Rubigo data"
status = "draft"

[[rules]]
id = "rule-mcp-schema"
feature_id = "feat-mcp-server"
role = "Rubigo Developer"
requirement = "discover available resources and tools through MCP protocol introspection"
reason = "enable AI tools to dynamically understand what operations are available"
status = "draft"

# ============================================================================
# SCENARIOS - Test cases for MCP integration
# ============================================================================

# --- Resource Scenarios ---

[[scenarios]]
id = "scen-mcp-list-personnel"
rule_id = "rule-mcp-resources-read"
name = "List personnel via MCP"
narrative = "Given I have a valid MCP connection, when I request the personnel resource, then I receive a list of all personnel records with their attributes"
status = "draft"

[[scenarios]]
id = "scen-mcp-list-projects"
rule_id = "rule-mcp-resources-read"
name = "List projects via MCP"
narrative = "Given I have a valid MCP connection, when I request the projects resource, then I receive a list of all projects with their status and linked solutions"
status = "draft"

[[scenarios]]
id = "scen-mcp-list-objectives"
rule_id = "rule-mcp-resources-read"
name = "List objectives via MCP"
narrative = "Given I have a valid MCP connection, when I request the objectives resource, then I receive the objective hierarchy with parent-child relationships"
status = "draft"

# --- Tool Scenarios ---

[[scenarios]]
id = "scen-mcp-create-personnel"
rule_id = "rule-mcp-tools-crud"
name = "Create personnel via MCP tool"
narrative = "Given I have authenticated MCP connection with admin privileges, when I invoke the create_personnel tool with name and email, then a new personnel record is created and returned"
status = "draft"

[[scenarios]]
id = "scen-mcp-update-objective"
rule_id = "rule-mcp-tools-crud"
name = "Update objective via MCP tool"
narrative = "Given I have authenticated MCP connection with admin privileges, when I invoke the update_objective tool with an ID and new title, then the objective is updated and the change is logged"
status = "draft"

[[scenarios]]
id = "scen-mcp-delete-activity"
rule_id = "rule-mcp-tools-crud"
name = "Delete activity via MCP tool"
narrative = "Given I have authenticated MCP connection with admin privileges, when I invoke the delete_activity tool with a valid ID, then the activity is removed from the system"
status = "draft"

# --- Transport Scenarios ---

[[scenarios]]
id = "scen-mcp-sse-connect"
rule_id = "rule-mcp-transport-sse"
name = "Connect via HTTP/SSE"
narrative = "Given the Rubigo MCP server is running, when I establish an SSE connection to the MCP endpoint, then I receive the protocol handshake and can begin exchanging messages"
status = "draft"

[[scenarios]]
id = "scen-mcp-sse-reconnect"
rule_id = "rule-mcp-transport-sse"
name = "Reconnect after disconnect"
narrative = "Given an active SSE connection is interrupted, when the client reconnects, then the connection is re-established and operations can continue"
status = "draft"

# --- Authentication Scenarios ---

[[scenarios]]
id = "scen-mcp-auth-valid-token"
rule_id = "rule-mcp-auth"
name = "Authenticate with valid token"
narrative = "Given I have a valid API token, when I connect to the MCP server with the token in the Authorization header, then the connection is established successfully"
status = "draft"

[[scenarios]]
id = "scen-mcp-auth-invalid-token"
rule_id = "rule-mcp-auth"
name = "Reject invalid token"
narrative = "Given I have an invalid or expired API token, when I attempt to connect to the MCP server, then the connection is rejected with an authentication error"
status = "draft"

[[scenarios]]
id = "scen-mcp-auth-readonly"
rule_id = "rule-mcp-auth"
name = "Enforce role-based access"
narrative = "Given I have an authenticated connection without admin privileges, when I invoke a write tool like create_personnel, then the operation is rejected with a permissions error"
status = "draft"

# --- Schema Discovery Scenarios ---

[[scenarios]]
id = "scen-mcp-discover-resources"
rule_id = "rule-mcp-schema"
name = "Discover available resources"
narrative = "Given I have a valid MCP connection, when I send a resources/list request, then I receive a list of all available resources with their URIs and descriptions"
status = "draft"

[[scenarios]]
id = "scen-mcp-discover-tools"
rule_id = "rule-mcp-schema"
name = "Discover available tools"  
narrative = "Given I have a valid MCP connection, when I send a tools/list request, then I receive a list of all available tools with their input schemas and descriptions"
status = "draft"

# ============================================================================
# SPECIFICATIONS - Non-functional requirements
# ============================================================================

[[specifications]]
id = "spec-mcp-protocol-version"
feature_id = "feat-mcp-server"
name = "MCP Protocol Compliance"
narrative = "The MCP server MUST implement MCP protocol version 1.0 or later as defined by the Model Context Protocol specification"
category = "compatibility"
status = "draft"

[[specifications]]
id = "spec-mcp-full-ontology"
feature_id = "feat-mcp-server"
name = "Full Ontology Coverage"
narrative = "The MCP server MUST expose all Rubigo ontology entities: personnel, solutions, products, services, releases, projects, objectives, features, rules, scenarios, specifications, evidences, evaluations, metrics, kpis, initiatives, activities, roles, assignments, allocations"
category = "completeness"
status = "draft"

[[specifications]]
id = "spec-mcp-action-logging"
feature_id = "feat-mcp-server"
name = "Action Log Integration"
narrative = "All CRUD operations performed through MCP tools MUST be recorded in the action_logs table with source='api'"
category = "auditability"
status = "draft"

[[specifications]]
id = "spec-mcp-sse-timeout"
feature_id = "feat-mcp-server"
name = "SSE Connection Timeout"
narrative = "The MCP SSE endpoint SHOULD send keepalive messages at least every 30 seconds to prevent connection timeout"
category = "reliability"
status = "draft"
